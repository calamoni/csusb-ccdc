base_dir := "/opt/keyboard_kowboys"
scripts_dir := base_dir + "/scripts"
ops_dir := base_dir + "/ops"
playbooks_dir := base_dir + "/playbooks"
single-node_dir := base_dir + "/single-node"
backup_dir := base_dir + "/backups"
tools_dir := base_dir + "/tools"
config_dir := base_dir + "/configs"
log_dir := base_dir + "/logs"

# Display available commands with descriptions
default:
    @just --list

# Display help for recipes and their options
help recipe="":
    #!/bin/sh
    if [ -z "{{recipe}}" ]; then
        echo "===== KEYBOARD KOWBOYS OPERATIONS HELP ====="
        echo "Usage: just help <recipe>"
        echo ""
        echo "Available recipes:"
        just --summary
        echo ""
        echo "For detailed help on a specific recipe, run: just help <recipe-name>"
    else
        echo "===== HELP: {{recipe}} ====="
        
        # Extract recipe definition to show all options
        RECIPE_DEF=$(just --show {{recipe}} | grep -E "^{{recipe}}.*:$" | head -1)
        if [ -n "$RECIPE_DEF" ]; then
            echo "USAGE: just $RECIPE_DEF" | sed 's/://'
        fi
        
        echo ""
        echo "DESCRIPTION:"
        just --show {{recipe}} | grep -E "^# " | sed 's/^# //' || echo "No help available for '{{recipe}}'"
        
        # Add specific option information for certain commands
        case "{{recipe}}" in
            "backup")
                echo ""
                echo "AVAILABLE BACKUP TYPES:"
                echo "  all        - Backup all system configurations (includes security)"
                echo "  security   - Security-critical files (STIG compliance: PAM, SSH, sudo, SELinux, etc.)"
                echo "  audit      - Audit logs and compliance data"
                echo "  network    - Network-related configurations (/etc/hosts, /etc/resolv.conf, etc.)"
                echo "  firewall   - Firewall rules and configurations"
                echo "  services   - Service definitions and configurations"
                echo "  database   - Database configurations and schemas"
                echo "  web        - Web server configurations"
                echo "  custom     - Custom backup defined in config file"
                echo ""
                echo "ADVANCED OPTIONS (set in config file):"
                echo "  Compression level:  1-9 (default: 9)"
                echo "  Retention:          Days to keep backups (default: 30)"
                echo "  Encryption:         Enable/disable (default: disabled)"
                echo "  Remote backup:      Enable/disable (default: disabled)"
                echo "  Backup method:      tar, rsync, duplicity (default: rsync)"
                ;;
            "diff")
                echo ""
                echo "AVAILABLE DIFF TARGETS:"
                echo "  ports       - Compare listening network ports"
                echo "  connections - Compare active network connections"
                echo "  processes   - Compare running processes"
                echo "  services    - Compare active services"
                echo "  users       - Compare logged in users"
                echo "  configs     - Compare configuration files"
                echo "  packages    - Compare installed packages"
                echo "  mounts      - Compare mounted filesystems"
                echo "  files       - Compare specific files"
                echo "  all         - Compare all of the above"
                echo ""
                echo "SYSTEM TYPES (same as backup types):"
                echo "  all, network, firewall, services, database, web, custom"
                echo ""
                echo "DATE FORMAT:"
                echo "  YYYYMMDD (e.g., 20250315 for March 15, 2025)"
                ;;
        esac
        
        echo ""
        echo "EXAMPLES:"
        case "{{recipe}}" in
            "backup")
                echo "  just backup              # Backup all systems (includes security)"
                echo "  just backup security     # Backup security-critical files (STIG)"
                echo "  just backup audit        # Backup audit logs and compliance data"
                echo "  just backup network      # Backup only network configs"
                echo "  just backup database     # Backup database configs"
                ;;
            "diff")
                echo "  just diff                # Compare config files with latest backup"
                echo "  just diff ports          # Compare listening ports"
                echo "  just diff processes all 20250315  # Compare processes with March 15th backup"
                echo "  just diff services network        # Compare services using network backup"
                ;;
            "diff-files")
                echo "  just diff-files \"/etc/hosts /etc/hostname\"  # Compare specific files"
                ;;
            *)
                # Extract examples from the recipe documentation
                EXAMPLES=$(just --show {{recipe}} | grep -A 10 "Usage:" | grep -v "Usage:")
                if [ -n "$EXAMPLES" ]; then
                    echo "$EXAMPLES"
                else
                    echo "  just {{recipe}}  # Run the {{recipe}} command"
                fi
                ;;
        esac
    fi

# Start real-time file monitoring
#
# Starts the monitor.sh script in the background to watch critical system files.
# Monitors cron, user accounts, sudo, SSH keys, and other security-sensitive files.
# Useful for detecting unauthorized changes in real-time.
#
# Usage: just start-monitor
start-monitor:
    #!/bin/sh
    echo "Starting real-time file monitoring..."
    nohup {{scripts_dir}}/monitor.sh > {{log_dir}}/monitor.log 2>&1 &
    echo "Monitor started. Logs: {{log_dir}}/monitor.log"
    echo "Use 'just monitor-status' to check status"
    echo "Use 'just stop-monitor' to stop monitoring"

# Stop real-time file monitoring
#
# Stops the background monitor.sh process.
# Use this to halt real-time file monitoring when no longer needed.
#
# Usage: just stop-monitor
stop-monitor:
    #!/bin/sh
    echo "Stopping real-time file monitoring..."

    # Kill the main monitor.sh process and all its children
    if pgrep -f "{{scripts_dir}}/monitor.sh" >/dev/null; then
        # Get all PIDs of monitor.sh processes
        MONITOR_PIDS=$(pgrep -f "{{scripts_dir}}/monitor.sh")

        # Kill all inotifywait processes spawned by monitor.sh
        pkill -P $MONITOR_PIDS 2>/dev/null || true

        # Kill monitor.sh processes themselves
        pkill -f "{{scripts_dir}}/monitor.sh"

        # Give it a moment to clean up
        sleep 1

        # Force kill any remaining processes
        pkill -9 -f "{{scripts_dir}}/monitor.sh" 2>/dev/null || true

        # Kill any orphaned inotifywait processes
        pkill -9 inotifywait 2>/dev/null || true

        echo "Monitor stopped successfully"
    else
        echo "Monitor was not running"
    fi

# Check monitoring status
#
# Shows whether the real-time file monitoring is currently active.
# Displays process status and log file location.
#
# Usage: just monitor-status
monitor-status:
    #!/bin/sh
    echo "=== MONITOR STATUS ==="
    if pgrep -f monitor.sh >/dev/null; then
        echo "Status: RUNNING"
        echo "Process ID: $(pgrep -f monitor.sh)"
        echo "Log file: {{log_dir}}/monitor.log"
        echo "Started: $(ps -o lstart= -p $(pgrep -f monitor.sh) 2>/dev/null || echo 'Unknown')"
    else
        echo "Status: STOPPED"
        echo "Use 'just start-monitor' to begin monitoring"
    fi

# Run baseline hardening using chimera
# 
# Applies baseline security hardening measures using the chimera tool.
# This strengthens the system against common attacks and vulnerabilities.
# 
# Usage: just harden
harden:
    cd {{ops_dir}} && ./chimera baseline

# Run inventory using chimera
#
# Gathers system inventory information using the chimera tool.
# Useful for asset management and compliance reporting.
#
# Usage: just inventory
inventory:
    cd {{ops_dir}} && ./chimera inventory
    mv /tmp/output/inventory.json {{log_dir}}/inventory-$(date +%Y%m%d-%H%M%S).json

# Back up critical system files
# 
# Creates a backup of system configurations based on the specified system name.
# Uses rsync for incremental backups to improve speed and efficiency.
# Also captures a snapshot of current network connections for quick reference.
# 
# Options:
#   system_name - Type of system to back up (default: "all")
#                 Valid options: all, security, audit, network, firewall, services, database, web, custom
#
# Advanced options (can be set in config file):
#   - Compression level (1-9)
#   - Retention policy for old backups
#   - Encryption of backups (requires GPG)
#   - Remote backup destinations
#   - File/directory exclusion patterns
#   - Alternative backup methods (tar, rsync, duplicity)
# 
# Usage:
#   just backup              # Back up all configurations (includes security)
#   just backup security     # Back up security-critical files (STIG compliance)
#   just backup audit        # Back up audit logs and compliance data
#   just backup network      # Back up only network configurations
#   just backup firewall     # Back up only firewall settings
#   just backup database     # Back up database configurations
# Updated backup recipe with environment variables to make paths dynamic
backup system_name="all":
    #!/bin/sh
    echo "backing up {{system_name}} configurations and system state..."
    
    # Check if we're running as root for operations that require it
    if [ -f "/etc/passwd" ] || [ -f "/etc/shadow" ] || [ -d "/etc/ssh" ]; then
        if [ "$(id -u)" -ne 0 ]; then
            echo "ERROR: Root privileges required for backing up system files."
            echo "Please run this command as root or with appropriate privileges."
            exit 1
        fi
    fi
    
    # Export all keyboard_kowboys environment variables
    export KK_BASE_DIR="{{base_dir}}"
    export KK_CONFIG_DIR="{{config_dir}}"
    export KK_LOG_DIR="{{log_dir}}"
    
    # Run the backup script with the environment variables (no sudo)
    {{scripts_dir}}/backup.sh -v {{system_name}} {{backup_dir}}/{{system_name}}
    
    # Create a quick snapshot of current network connections in a separate file
    # for easy access without needing to browse the full backup
    echo "capturing current network connections snapshot..."
    CONNECTION_FILE="{{log_dir}}/connections-$(date +%Y%m%d-%H%M%S).txt"
    echo "==== NETWORK CONNECTIONS SNAPSHOT ====" > $CONNECTION_FILE
    echo "Date: $(date)" >> $CONNECTION_FILE
    echo "System: $(hostname)" >> $CONNECTION_FILE
    echo "" >> $CONNECTION_FILE
    
    # Use available tool to capture connections (removed sudo)
    if command -v ss >/dev/null 2>&1; then
        echo "== LISTENING PORTS ==" >> $CONNECTION_FILE
        ss -tuln >> $CONNECTION_FILE
        echo "" >> $CONNECTION_FILE
        echo "== ALL CONNECTIONS ==" >> $CONNECTION_FILE
        ss -tunapl >> $CONNECTION_FILE
    elif command -v netstat >/dev/null 2>&1; then
        echo "== LISTENING PORTS ==" >> $CONNECTION_FILE
        netstat -tuln >> $CONNECTION_FILE
        echo "" >> $CONNECTION_FILE
        echo "== ALL CONNECTIONS ==" >> $CONNECTION_FILE
        netstat -tunapl >> $CONNECTION_FILE
    else
        echo "Neither ss nor netstat available" >> $CONNECTION_FILE
    fi
    
    echo "Backup complete. See {{log_dir}}/backup.log for details."
    echo "Network connection snapshot saved to $CONNECTION_FILE"

# Create named backup snapshot for easy reference
#
# Creates a timestamped backup with a custom name for easy identification.
# Useful for creating known-good snapshots before making changes.
#
# The snapshot name is appended to the standard backup directory name.
# Example: "pre-comp" creates backup named "all-hostname-20251016-120000-pre-comp"
#
# Usage:
#   just backup-snapshot pre-comp           # Before competition starts
#   just backup-snapshot known-good         # Known-good baseline
#   just backup-snapshot before-hardening   # Before applying hardening
backup-snapshot name:
    #!/bin/sh
    # Export environment variables
    export KK_BASE_DIR="{{base_dir}}"
    export KK_CONFIG_DIR="{{config_dir}}"
    export KK_LOG_DIR="{{log_dir}}"
    export KK_BACKUP_DIR="{{backup_dir}}"
    export KK_SCRIPTS_DIR="{{scripts_dir}}"

    {{scripts_dir}}/backup_snapshot.sh "{{name}}"

# Quick restore from backup (no safety checks)
#
# Rapidly restores a system component from backup.
# NO safety snapshots, NO verification - just fast restore.
# USER is responsible for safety - use with caution!
#
# Options:
#   type - Component to restore (network, firewall, services, ssh, web, database, all)
#   date - Backup date or named snapshot (default: latest)
#
# WARNING: This directly overwrites system files and restarts services.
# Ensure you have console access before restoring network/SSH configurations.
#
# Usage:
#   just restore-quick network              # Restore from latest network backup
#   just restore-quick firewall 20251016    # Restore from specific date
#   just restore-quick all known-good       # Restore from named snapshot
restore-quick type date="latest":
    #!/bin/sh
    # Export environment variables
    export KK_BASE_DIR="{{base_dir}}"
    export KK_BACKUP_DIR="{{backup_dir}}"

    {{scripts_dir}}/restore_quick.sh "{{type}}" "{{date}}"

# Compare current system state against last backup
# 
# Compares the current system state with a previous backup to identify changes.
# Useful for security monitoring and configuration drift detection.
# 
# Options:
#   target      - What to compare (default: "configs")
#                 Valid options: ports, connections, processes, services, users, 
#                 configs, packages, mounts, files, all
#   system_type - Which backup type to compare against (default: "all")
#   date        - Specific backup date to use (default: latest)
# 
# Usage:
#   just diff                     # Compare configuration files
#   just diff ports network       # Compare network ports from network backup
#   just diff processes all 20250315  # Compare processes with March 15th backup
diff target="configs" system_type="all" date="":
    #!/bin/sh
    echo "Comparing current {{target}} with backup data..."
    
    # Check if we're running as root for operations that require it
    if [ "{{target}}" = "configs" ] || [ "{{target}}" = "files" ] || [ "{{target}}" = "all" ]; then
        if [ "$(id -u)" -ne 0 ]; then
            echo "WARNING: Some file comparisons may fail without root privileges."
            echo "Consider running as root for complete results."
        fi
    fi
    
    # Make sure directories exist
    mkdir -p {{backup_dir}}/{{system_type}}/latest/system_info || true
    
    # Make sure the script has execute permissions
    chmod +x {{scripts_dir}}/diff.sh
    
    # Export environment variables
    export KK_BASE_DIR="{{base_dir}}"
    export KK_BACKUP_DIR="{{backup_dir}}"
    export KK_LOG_DIR="{{log_dir}}" 
    export KK_CONFIG_DIR="{{config_dir}}"
    
    # Build options with proper quoting
    OPTS=""
    if [ "{{system_type}}" != "all" ]; then
        OPTS="$OPTS -s {{system_type}}"
    fi
    
    if [ "{{date}}" != "" ]; then
        OPTS="$OPTS -d {{date}}"
    fi
    
    # Run command (no sudo)
    {{scripts_dir}}/diff.sh $OPTS {{target}}

# Compare listening ports to detect new services
# 
# Checks for changes in listening network ports since the last backup.
# Useful for detecting unauthorized services or changes to network configuration.
# 
# Usage: just diff-ports
diff-ports:
    @just diff ports

# Compare processes to check for unexpected applications
# 
# Detects changes in running processes since the last backup.
# Helps identify unauthorized or suspicious processes.
# 
# Usage: just diff-processes
diff-processes:
    @just diff processes

# Compare network connections to check activity changes
# 
# Detects changes in network connections since the last backup.
# Useful for identifying unusual network activity or potential data exfiltration.
# 
# Usage: just diff-connections
diff-connections:
    @just diff connections

# Compare services to detect service changes
# 
# Identifies changes in running services since the last backup.
# Helps detect unauthorized service modifications or additions.
# 
# Usage: just diff-services
diff-services:
    @just diff services

# Check for new installed packages
#
# Compares the currently installed packages with the last backup.
# Useful for detecting unauthorized software installations.
#
# Usage: just diff-packages
diff-packages:
    @just diff packages

# Check for persistence mechanisms and backdoors
#
# Scans the system for common persistence mechanisms used by attackers:
#   - Suspicious cron jobs
#   - New/modified systemd services and timers
#   - Changes to rc.local and init scripts
#   - Backdoors in shell profiles (.bashrc, .profile, etc.)
#   - LD_PRELOAD hijacking
#   - New kernel modules
#   - Modified SSH authorized_keys
#   - Unusual SUID/SGID binaries
#
# Options:
#   -v, --verbose     Enable verbose output
#   -c, --cron        Check cron jobs only
#   -s, --systemd     Check systemd services only
#   -i, --init        Check init scripts only
#   -p, --profiles    Check shell profiles only
#   -l, --ld-preload  Check LD_PRELOAD only
#   -k, --kernel      Check kernel modules only
#   --ssh             Check SSH keys only
#   --suid            Check SUID/SGID files only
#
# Usage:
#   just check-persistence              # Run all checks
#   just check-persistence -v           # Run with verbose output
#   just check-persistence --cron --ssh # Check only cron and SSH
check-persistence *args="":
    #!/bin/sh
    # Check for root privileges if needed for full system scan
    if [ "$(id -u)" -ne 0 ]; then
        echo "WARNING: Running without root privileges. Some checks may be incomplete."
        echo "For complete results, run as root"
        echo ""
    fi

    # Export environment variables
    export KK_BASE_DIR="{{base_dir}}"
    export KK_LOG_DIR="{{log_dir}}"
    export KK_BACKUP_DIR="{{backup_dir}}"

    # Run the persistence check script
    {{scripts_dir}}/check_persistence.sh {{args}}

# Compare specific files with previous backup
# 
# Compares specified files with their versions in the previous backup.
# Useful for tracking changes to important configuration files.
# 
# Options:
#   files - Space-separated list of files to compare
# 
# Usage: just diff-files "/etc/hosts /etc/passwd"
diff-files files:
    @just diff files "-f \"{{files}}\""

# Check active network connections
# 
# Examines current network connections at the specified detail level.
# Useful for quick network audits or troubleshooting.
# 
# Options:
#   level - Detail level of network analysis (default: "basic")
#           "basic" shows just listening ports, "detailed" runs full analysis
# 
# Usage:
#   just network-eval           # Basic network connection check
#   just network-eval detailed  # Detailed network connection analysis
network-eval level="basic":
    #!/bin/sh
    echo "checking {{level}} network connections..."
    # Check if we're running on BusyBox
    if busybox 2>/dev/null | grep -q "BusyBox"; then
        echo "BusyBox detected, using busybox-compatible scripts..."
        if [ "{{level}}" = "basic" ]; then
            # BusyBox might not have ss, use netstat instead
            busybox netstat -tuln
        else
            {{scripts_dir}}/network_eval_busybox.sh
        fi
    else
        if [ "{{level}}" = "basic" ]; then
            ss -tuln
        else
            {{scripts_dir}}/network_eval.sh
        fi
    fi

# Deploy system monitoring
# 
# Sets up monitoring for the system using the configured monitoring solution.
# 
# Usage: just deploy-monitoring
deploy-monitoring:
    @{{scripts_dir}}/deploy_monitoring.sh

# Start system performance monitoring
#
# Starts background monitoring of CPU, memory, disk, and network usage.
# Useful for detecting resource exhaustion attacks and performance issues.
#
# Usage: just start-performance-monitor
start-performance-monitor:
    #!/bin/sh
    echo "Starting system performance monitoring..."
    nohup {{scripts_dir}}/run_monitoring.sh > {{log_dir}}/performance-monitor.log 2>&1 &
    echo "Performance monitoring started. Logs: {{log_dir}}/performance-monitor.log"
    echo "Data directory: {{log_dir}}/monitoring/data/"

# Stop system performance monitoring
#
# Stops the background performance monitoring process.
#
# Usage: just stop-performance-monitor
stop-performance-monitor:
    #!/bin/sh
    echo "Stopping system performance monitoring..."
    if pkill -f run_monitoring.sh; then
        echo "Performance monitoring stopped successfully"
    else
        echo "Performance monitoring was not running"
    fi

# Check performance monitoring status
#
# Shows whether system performance monitoring is currently active.
#
# Usage: just performance-monitor-status
performance-monitor-status:
    #!/bin/sh
    echo "=== PERFORMANCE MONITOR STATUS ==="
    if pgrep -f run_monitoring.sh >/dev/null; then
        echo "Status: RUNNING"
        echo "Process ID: $(pgrep -f run_monitoring.sh)"
        echo "Log file: {{log_dir}}/performance-monitor.log"
        echo "Data directory: {{log_dir}}/monitoring/data/"
        echo "Started: $(ps -o lstart= -p $(pgrep -f run_monitoring.sh) 2>/dev/null || echo 'Unknown')"
    else
        echo "Status: STOPPED"
        echo "Use 'just start-performance-monitor' to begin monitoring"
    fi

# Show monitoring dashboard
#
# Displays a comprehensive monitoring dashboard with system status,
# monitoring status, recent alerts, and critical file information.
#
# Usage: just monitor-dashboard 
monitor-dashboard:
    #!/bin/sh
    {{scripts_dir}}/monitor_dashboard.sh

# Watch monitoring dashboard
#
# Continuously displays the monitoring dashboard with automatic refresh.
# Default interval is 5 seconds.
#
# Usage: just watch-monitor [interval]
watch-monitor interval="5":
    #!/bin/sh
    {{scripts_dir}}/monitor_dashboard.sh --watch {{interval}}

# Analyze monitoring threats
#
# Analyzes monitoring logs to identify potential security threats
# and suspicious activities.
#
# Usage: just analyze-threats
analyze-threats:
    #!/bin/sh
    echo "=== THREAT ANALYSIS REPORT ==="
    echo "Generated: $(date)"
    echo ""
    
    # Check for user account changes
    echo "=== USER ACCOUNT CHANGES ==="
    if [ -f "{{log_dir}}/monitor.log" ]; then
        echo "Passwd file modifications:"
        grep -E "passwd.*modify|passwd.*create|passwd.*delete" "{{log_dir}}/monitor.log" 2>/dev/null | tail -10 || echo "  No passwd file changes detected"
        
        echo ""
        echo "Shadow file access:"
        grep -E "shadow.*open" "{{log_dir}}/monitor.log" 2>/dev/null | tail -10 || echo "  No shadow file access detected"
        
        echo ""
        echo "Group file modifications:"
        grep -E "group.*modify|group.*create|group.*delete" "{{log_dir}}/monitor.log" 2>/dev/null | tail -10 || echo "  No group file changes detected"
    else
        echo "No monitoring log found"
    fi
    
    echo ""
    echo "=== SUSPICIOUS FILE CHANGES ==="
    if [ -f "{{log_dir}}/monitor.log" ]; then
        grep -E "(sudoers|ssh)" "{{log_dir}}/monitor.log" 2>/dev/null | tail -10 || echo "No suspicious file changes found"
    else
        echo "No monitoring log found"
    fi
    
    echo ""
    echo "=== PRIVILEGE ESCALATION ATTEMPTS ==="
    if [ -f "{{log_dir}}/monitor.log" ]; then
        grep -E "(sudo|su|chmod|chown)" "{{log_dir}}/monitor.log" 2>/dev/null | tail -10 || echo "No privilege escalation attempts detected"
    else
        echo "No monitoring log found"
    fi
    
    echo ""
    echo "=== CRON/SCHEDULED TASK CHANGES ==="
    if [ -f "{{log_dir}}/monitor.log" ]; then
        grep -E "(cron|crontab)" "{{log_dir}}/monitor.log" 2>/dev/null | tail -10 || echo "No cron changes detected"
    else
        echo "No monitoring log found"
    fi
    
    echo ""
    echo "=== WEB DEFACEMENT ATTEMPTS ==="
    if [ -f "{{log_dir}}/monitor.log" ]; then
        grep -E "www.*modify|www.*create|www.*delete" "{{log_dir}}/monitor.log" 2>/dev/null | tail -10 || echo "No web root changes detected"
    else
        echo "No monitoring log found"
    fi
    
    echo ""
    echo "=== NETWORK ANOMALIES ==="
    if [ -d "{{log_dir}}/monitoring/data" ]; then
        grep -E "(LISTEN|ESTABLISHED)" "{{log_dir}}/monitoring/data/network_"*.log 2>/dev/null | tail -10 || echo "No network anomalies detected"
    else
        echo "No network monitoring data found"
    fi
    
    echo ""
    echo "=== CRITICAL ALERTS SUMMARY ==="
    if [ -f "{{log_dir}}/monitor.log" ]; then
        grep -c "CRITICAL" "{{log_dir}}/monitor.log" 2>/dev/null | awk '{print "Critical alerts: " $1}' || echo "Critical alerts: 0"
        grep -c "WARNING" "{{log_dir}}/monitor.log" 2>/dev/null | awk '{print "Warning alerts: " $1}' || echo "Warning alerts: 0"
        grep -c "INFO" "{{log_dir}}/monitor.log" 2>/dev/null | awk '{print "Info alerts: " $1}' || echo "Info alerts: 0"
    else
        echo "No monitoring log found"
    fi

# Verify service integrity
# 
# Checks the integrity of running services against expected configurations.
# Helps detect service tampering or unauthorized modifications.
# 
# Options:
#   critical_only - Whether to check only critical services (default: "true")
#                   Set to "false" to check all services
# 
# Usage:
#   just verify-services          # Verify only critical services
#   just verify-services false    # Verify all services
verify-services critical_only="true":
    @{{scripts_dir}}/verify_services.sh {{critical_only}}

# Run a quick system integrity check
# 
# Performs a quick check for potential system integrity issues.
# Checks binary checksums and identifies new SUID binaries.
# 
# Usage: just integrity-quick
integrity-quick:
    #!/bin/sh
    echo "running quick integrity checks..."
    
    # Check for root privileges since we need to access system binaries
    if [ "$(id -u)" -ne 0 ]; then
        echo "WARNING: Running with limited privileges. Some files may not be accessible."
        echo "For complete results, run this command as root."
    fi
    
    find /bin /sbin /usr/bin -type f -exec md5sum {} \; 2>/dev/null | grep -vf {{backup_dir}}/binaries.md5
    echo "checking for new suid binaries..."
    find / -perm -4000 2>/dev/null

# Reset firewall to known-good state
# 
# Restores the firewall configuration to a known-good state.
# Useful after suspected compromise or when troubleshooting network issues.
# 
# Usage: just reset-firewall
reset-firewall:
    #!/bin/sh
    # Check if we're running as root for firewall operations
    if [ "$(id -u)" -ne 0 ]; then
        echo "ERROR: Root privileges required for firewall operations."
        echo "Please run this command as root or with appropriate privileges."
        exit 1
    fi
    
    {{scripts_dir}}/reset_firewall.sh

# Review and analyze system logs
# 
# Analyzes system logs for a specified time period to identify issues or attacks.
# 
# Options:
#   hours - Number of hours of logs to analyze (default: 1)
# 
# Usage:
#   just analyze-logs       # Analyze the last hour of logs
#   just analyze-logs 24    # Analyze the last 24 hours of logs
analyze-logs hours="1":
    #!/bin/sh
    # Check if we need root for log access
    if [ ! -r "/var/log/syslog" ] && [ ! -r "/var/log/messages" ] && [ ! -r "/var/log/auth.log" ]; then
        if [ "$(id -u)" -ne 0 ]; then
            echo "WARNING: Limited log access. Some logs may not be accessible."
            echo "For complete results, run this command as root."
        fi
    fi
    
    {{scripts_dir}}/log_analyzer.sh {{hours}}

# Create an incident response snapshot
# 
# Captures current system state for incident response purposes.
# Useful when investigating potential security incidents.
# 
# Options:
#   name - Name/identifier for the incident snapshot
# 
# Usage: just incident-snapshot suspicious_login
incident-snapshot name:
    #!/bin/sh
    echo "creating incident snapshot: {{name}}"
    
    # Check for root privileges for complete system information
    if [ "$(id -u)" -ne 0 ]; then
        echo "WARNING: Running with limited privileges. Some system information may not be collected."
        echo "For complete results, run this command as root."
    fi
    
    mkdir -p {{backup_dir}}/incidents/{{name}}
    ps aux > {{backup_dir}}/incidents/{{name}}/processes.txt
    netstat -tulpn > {{backup_dir}}/incidents/{{name}}/connections.txt 2>/dev/null || ss -tulpn > {{backup_dir}}/incidents/{{name}}/connections.txt
    
    # Only attempt lsof if likely to succeed
    lsof > {{backup_dir}}/incidents/{{name}}/open_files.txt 2>/dev/null || echo "Could not collect open files information" > {{backup_dir}}/incidents/{{name}}/open_files.txt
    
    # Use journalctl if available, otherwise try direct log files
    if command -v journalctl >/dev/null 2>&1; then
        journalctl -n 500 > {{backup_dir}}/incidents/{{name}}/recent_logs.txt 2>/dev/null || echo "Could not access journalctl logs" > {{backup_dir}}/incidents/{{name}}/recent_logs.txt
    else
        tail -n 500 /var/log/syslog /var/log/auth.log /var/log/messages 2>/dev/null > {{backup_dir}}/incidents/{{name}}/recent_logs.txt || echo "Could not access log files" > {{backup_dir}}/incidents/{{name}}/recent_logs.txt
    fi
    
    echo "snapshot saved to {{backup_dir}}/incidents/{{name}}/"

# Install or update security tools
# 
# Installs required security tools using Nix package manager.
# Will install Nix first if it's not already available.
# 
# Usage: just install-tools
install-tools:
    #!/bin/sh
    if ! command -v nix-env >/dev/null 2>&1; then
        echo "Nix not found. Installing Nix first..."
        {{scripts_dir}}/install_nix.sh
    else
        echo "Nix is already installed"
    fi
    echo "Installing/updating tools..."
    {{scripts_dir}}/install_tools.sh

# Scan for personally identifiable information
# 
# Searches the system for potentially exposed PII (Personal Identifiable Information).
# Helps identify data privacy risks and compliance issues.
# 
# Usage: just find-pii
find-pii:
    #!/bin/sh
    # Check for root privileges for complete file access
    if [ "$(id -u)" -ne 0 ]; then
        echo "WARNING: Running with limited privileges. Some files may not be accessible."
        echo "For complete results, run this command as root."
    fi
    
    {{scripts_dir}}/find_pii.sh

# Usage: just remote all|hostname|ip
remote action="help" target="all":
    #!/bin/sh

    # If the action is "help", show the available options
    if [ "{{action}}" = "help" ]; then
        just default
        exit 0
    elif [ "{{action}}" = "install" ]; then
        if [ "{{target}}" = "all" ]; then
            ansible-playbook -i {{base_dir}}/hosts.ini {{playbooks_dir}}/just_install.yml --ask-vault-pass
            exit 0
        else
            ansible-playbook -i {{base_dir}}/hosts.ini --limit {{target}} {{playbooks_dir}}/just_install.yml --ask-vault-pass
            exit 0
        fi
    fi

    echo "running remote command on {{target}}"
    {{scripts_dir}}/remote.sh {{action}} {{target}}

# Usage: just install-wazuh
install-wazuh:
    #!/bin/sh

    # Checks if dependencies are present in the parent directory
    if [ ! -d "{{single-node_dir}}" ]; then
        echo "Directory '{{single-node_dir}}' not found. Pulling from GitHub..."
        wget --no-check-certificate -O wazuh-server.zip https://github.com/CSUSB-CISO/csusb-ccdc/releases/download/CCDC-2024-2025/wazuh-server.zip
        echo "Unzipping Wazuh server deps files..."
        unzip -o wazuh-server.zip -d {{base_dir}}
        exit 0
    fi

    echo "Wazuh server dependencies found. Proceeding with installation..."
    echo
    echo "Adjusting script permissions..."
    chmod +x {{single-node_dir}}/wazuh_server_install.sh

    echo "Installing Wazuh server..."
    {{single-node_dir}}/wazuh_server_install.sh

#  Usage: just show (hosts)
show target="hosts":
    #!/bin/sh
    echo "=== Keyboard Kowboys show {{target}} ==="
    if [ "{{target}}" = "hosts" ]; then
        {{scripts_dir}}/show_hosts.sh
    else
        echo "Unknown target: {{target}}"
    fi

# Usage: just add-agent (server_ip)
add-agent server_ip="":
    #!/bin/sh
    echo "=== Keyboard Kowboys add-agent ==="
    if [ -z "{{server_ip}}" ]; then
        echo "Usage: just add-agent <server_ip>"
        exit 1
    fi

    is_ip_valid=false

    # Store the hosts in a temporary variable
    host_list=$(just show hosts | grep : | awk '{print $3}')
    
    # Check if the server IP is valid
    for ip in $host_list; do
        if [ "$ip" = "{{server_ip}}" ]; then
            echo "Server IP {{server_ip}} is valid."
            is_ip_valid=true
            break
        fi
    done

    echo is_ip_valid=$is_ip_valid
    
    # Only proceed if the IP is valid
    if [ "$is_ip_valid" = "true" ]; then
        {{scripts_dir}}/wazuh_agent_install.sh {{server_ip}}
    else
        echo "Error: Invalid server IP {{server_ip}}"
        echo "Refer to the list of hosts using 'just show hosts'"
        exit 1
    fi

# Usage just install-docker
install-docker:
    #!/bin/sh
    echo "=== Keyboard Kowboys install-docker ==="
    {{scripts_dir}}/docker-static.sh

# Import domain users to local accounts
#
# Creates local copies of domain users to maintain access when domain is down.
# Useful for maintaining system access during domain controller outages.
# Requires a CSV file with username,password format.
#
# Format: username,password (one user per line, first line should be header)
#
# Usage: just import-users <csv_file>
import-users csv_file:
    #!/bin/sh
    echo "=== Keyboard Kowboys import-users ==="
    if [ ! -f "{{csv_file}}" ]; then
        echo "ERROR: CSV file not found: {{csv_file}}"
        echo ""
        echo "Usage: just import-users <csv_file>"
        echo ""
        echo "CSV Format:"
        echo "  username,password"
        echo "  user1,pass123"
        echo "  user2,pass456"
        exit 1
    fi

    if [ "$(id -u)" -ne 0 ]; then
        echo "ERROR: Root privileges required for user management"
        exit 1
    fi

    {{scripts_dir}}/import_users.sh "{{csv_file}}"
    echo "User import complete. Backup created in /root/user_management_backup_*"

# Emergency service shutdown
#
# Stops, disables, and masks a service to prevent it from running.
# Works with systemd, init.d, and BSD-style service management.
# Useful during incident response when a service is compromised.
#
# Automatically saves the last 100 log entries for the service before shutdown.
#
# Usage: just service-kill <service_name>
service-kill service:
    #!/bin/sh
    # Export environment variables
    export KK_BASE_DIR="{{base_dir}}"
    export KK_LOG_DIR="{{log_dir}}"

    {{scripts_dir}}/service_kill.sh "{{service}}"

# Restore a killed service
#
# Unmasks, enables, and starts a service that was previously killed.
# Works with systemd, init.d, and BSD-style service management.
#
# Usage: just service-restore <service_name>
service-restore service:
    #!/bin/sh
    {{scripts_dir}}/service_restore.sh "{{service}}"


# Display system status dashboard
# 
# Shows a quick overview of the current system state.
# Displays uptime, running services, network connections, and recent auth attempts.
# 
# Usage: just status
status:
    #!/bin/sh
    echo "=== keyboard kowboys system status ==="
    echo "time: $(date)"
    echo "uptime: $(uptime)"
    echo "---"
    echo "services:"
    systemctl list-units --state=running --type=service 2>/dev/null | head -10 || echo "systemctl not available"
    echo "---"
    echo "connections:"
    ss -tuln 2>/dev/null | head -10 || netstat -tuln 2>/dev/null | head -10 || echo "network tools not available"
    echo "---"
    echo "recent auth attempts:"
    if [ -r "/var/log/auth.log" ]; then
        grep "authentication failure" /var/log/auth.log 2>/dev/null | tail -5 || echo "no recent auth failures"
    else
        echo "auth log not accessible - run as root to view auth failures"
    fi
