# Cross platform shebang
shebang := if os() == 'windows' {
  'powershell.exe'
} else {
  '/usr/bin/env pwsh'
}

# Set shell for non-Windows OSs
set shell := ["pwsh", "-c"]

# Set shell for Windows OSs
set windows-shell := ["powershell.exe", "-NoLogo", "-Command"]

# Define directories
base_dir := "C:/KeyboardKowboys"
scripts_dir := base_dir + "/scripts"
ops_dir := base_dir + "/ops"
backup_dir := base_dir + "/backups"
tools_dir := base_dir + "/tools"
config_dir := base_dir + "/configs"
log_dir := base_dir + "/logs"

# Display available commands with descriptions
default:
    just --list

# Display help for recipes and their options
help recipe="":
    #!{{shebang}}
    if ('{{recipe}}' -eq '') {
        Write-Host '===== KEYBOARD KOWBOYS OPERATIONS HELP =====' -ForegroundColor Cyan
        Write-Host 'Usage: just help <recipe>' -ForegroundColor Yellow
        Write-Host ''
        Write-Host 'Available recipes:' -ForegroundColor Green
        just --summary
        Write-Host ''
        Write-Host 'For detailed help on a specific recipe, run: just help <recipe-name>' -ForegroundColor Yellow
    } else {
        Write-Host '===== HELP: {{recipe}} =====' -ForegroundColor Cyan
        if ('{{recipe}}' -eq 'backup') {
            Write-Host 'USAGE: just backup [system_name]' -ForegroundColor Yellow
            Write-Host ''
            Write-Host 'DESCRIPTION:' -ForegroundColor Green
            Write-Host 'Creates a backup of system configurations based on the specified system name.'
            Write-Host 'Uses robocopy for incremental backups to improve speed and efficiency.'
            Write-Host 'Also captures a snapshot of current network connections for quick reference.'
            Write-Host ''
            Write-Host 'AVAILABLE BACKUP TYPES:' -ForegroundColor Green
            Write-Host '  all        - Backup all system configurations'
            Write-Host '  network    - Only network-related configurations'
            Write-Host '  firewall   - Firewall rules and configurations'
            Write-Host '  services   - Service definitions and configurations'
            Write-Host '  database   - Database configurations and schemas'
            Write-Host '  web        - Web server configurations'
            Write-Host '  custom     - Custom backup defined in config file'
            Write-Host ''
            Write-Host 'EXAMPLES:' -ForegroundColor Green
            Write-Host '  just backup              # Backup all systems'
            Write-Host '  just backup network      # Backup only network configs'
            Write-Host '  just backup database     # Backup database configs'
        } elseif ('{{recipe}}' -eq 'network-eval') {
            Write-Host 'USAGE: just network-eval [level]' -ForegroundColor Yellow
            Write-Host ''
            Write-Host 'DESCRIPTION:' -ForegroundColor Green
            Write-Host 'Examines current network connections at the specified detail level.'
            Write-Host 'Useful for quick network audits or troubleshooting.'
            Write-Host ''
            Write-Host 'OPTIONS:' -ForegroundColor Green
            Write-Host '  level - Detail level (basic/detailed)'
            Write-Host ''
            Write-Host 'EXAMPLES:' -ForegroundColor Green
            Write-Host '  just network-eval           # Basic network connection check'
            Write-Host '  just network-eval detailed  # Detailed network connection analysis'
        } elseif ('{{recipe}}' -eq 'harden') {
            Write-Host 'USAGE: just harden' -ForegroundColor Yellow
            Write-Host ''
            Write-Host 'DESCRIPTION:' -ForegroundColor Green
            Write-Host 'Runs the Invoke-EzScript.ps1 to perform comprehensive system hardening.'
            Write-Host 'This script applies security baseline configurations including:'
            Write-Host '  - Audit policy configuration'
            Write-Host '  - SMB protocol security settings'
            Write-Host '  - Group policy security settings'
            Write-Host '  - Kerberos and Zerologon mitigations'
            Write-Host '  - Windows Defender optimization'
            Write-Host '  - Firewall rules configuration'
            Write-Host '  - Registry security hardening'
            Write-Host '  - Local account security'
            Write-Host ''
            Write-Host 'EXAMPLES:' -ForegroundColor Green
            Write-Host '  just harden  # Run the full hardening script'
        } else {
            Write-Host 'USAGE: just {{recipe}}' -ForegroundColor Yellow
            Write-Host ''
            Write-Host 'DESCRIPTION:' -ForegroundColor Green
            Write-Host 'No specific help available for this command.'
            Write-Host ''
            Write-Host 'EXAMPLES:' -ForegroundColor Green
            Write-Host '  just {{recipe}}  # Run the {{recipe}} command'
        }
    }

# Initialize directory structure (run once or after reset)
init:
    #!{{shebang}}
    Write-Host 'Setting up keyboard kowboys operation environment...' -ForegroundColor Green
    $Dirs = @('{{base_dir}}', '{{scripts_dir}}', '{{ops_dir}}', '{{backup_dir}}', '{{tools_dir}}', '{{config_dir}}', '{{log_dir}}')
    foreach ($Dir in $Dirs) {
        if (-not (Test-Path $Dir)) {
            New-Item -Path $Dir -ItemType Directory -Force | Out-Null
            Write-Host ('Created directory: ' + $Dir) -ForegroundColor Yellow
        } else {
            Write-Host ('Directory already exists: ' + $Dir) -ForegroundColor Cyan
        }
    }
    $Acl = Get-Acl -Path '{{base_dir}}'
    $Ar = New-Object System.Security.AccessControl.FileSystemAccessRule('Administrators', 'FullControl', 'ContainerInherit,ObjectInherit', 'None', 'Allow')
    $Acl.SetAccessRule($Ar)
    Set-Acl -Path '{{base_dir}}' -AclObject $Acl
    Write-Host 'Directory structure created at {{base_dir}}' -ForegroundColor Green

# Run comprehensive system hardening
harden:
    #!{{shebang}}
    Write-Host '===== Keyboard Kowboys Security Hardening =====' -ForegroundColor Cyan
    $timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
    $logFile = '{{log_dir}}/hardening_' + $timestamp + '.log'
    $ezScriptDir = "C:\Program Files\ezScript"
    
    # Set environment variables for the script
    $env:KK_BASE_DIR = '{{base_dir}}'
    $env:KK_CONFIG_DIR = '{{config_dir}}'
    $env:KK_LOG_DIR = '{{log_dir}}'
    
    Write-Host 'Starting comprehensive hardening process. This may take several minutes...' -ForegroundColor Yellow
    Write-Host ('Log will be saved to: ' + $logFile) -ForegroundColor Yellow
    
    # Create ezScript directory if it doesn't exist
    if (-not (Test-Path $ezScriptDir)) {
        Write-Host "Creating ezScript directory..." -ForegroundColor Yellow
        New-Item -Path $ezScriptDir -ItemType Directory -Force | Out-Null
    }
    
    # Check if OS is Windows
    if ($IsWindows -or $env:OS -eq 'Windows_NT') {
        # Check administrator privileges
        $isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
        if (-not $isAdmin) {
            Write-Host 'Error: This script requires administrator privileges.' -ForegroundColor Red
            Write-Host 'Please run the command with elevated privileges and try again.' -ForegroundColor Yellow
            exit 1
        }
        
        Write-Host 'Executing EzScript hardening process...' -ForegroundColor Green
        
        # Run the hardening script and capture output
        & {{scripts_dir}}/Invoke-EzScript.ps1 -LogFile $logFile -Verbose *>&1 | 
            Tee-Object -FilePath $logFile -Append |
            ForEach-Object { 
                if ($_ -match 'ERROR|FAIL|CRITICAL') {
                    Write-Host $_ -ForegroundColor Red
                } elseif ($_ -match 'WARNING') {
                    Write-Host $_ -ForegroundColor Yellow
                } elseif ($_ -match 'SUCCESS|COMPLETED') {
                    Write-Host $_ -ForegroundColor Green
                } else {
                    Write-Host $_
                }
            }
            
        if ($LASTEXITCODE -eq 0) {
            Write-Host "`nHardening completed successfully!" -ForegroundColor Green
            Write-Host "The following security measures have been applied:" -ForegroundColor Green
            Write-Host "✓ Audit policies configured" -ForegroundColor Green
            Write-Host "✓ SMB security settings applied" -ForegroundColor Green
            Write-Host "✓ Group policies hardened" -ForegroundColor Green
            Write-Host "✓ Windows Defender optimized" -ForegroundColor Green
            Write-Host "✓ Firewall rules configured" -ForegroundColor Green
            Write-Host "✓ Registry security settings applied" -ForegroundColor Green
            Write-Host "✓ Local account security enforced" -ForegroundColor Green
        } else {
            Write-Host "`nHardening process completed with errors." -ForegroundColor Red
            Write-Host "Please review the log file for details: $logFile" -ForegroundColor Red
        }
    } else {
        Write-Host 'This hardening script is designed for Windows systems only.' -ForegroundColor Red
        exit 1
    }
    
    # Display location of logs and security files
    Write-Host "`nSecurity logs and configuration files:" -ForegroundColor Cyan
    Write-Host "- Detailed log: $logFile" -ForegroundColor Yellow
    Write-Host "- Security settings: C:\Program Files\SecurityConfig\" -ForegroundColor Yellow
    Write-Host "- EzScript working directory: $ezScriptDir" -ForegroundColor Yellow
    
    Write-Host "`nTo view the detailed log, run:" -ForegroundColor Cyan
    Write-Host "notepad $logFile" -ForegroundColor Yellow

# Back up critical system files
backup system_name="all":
    #!{{shebang}}
    Write-Host 'Backing up {{system_name}} configurations and system state...' -ForegroundColor Green
    $env:KK_BASE_DIR = '{{base_dir}}'
    $env:KK_CONFIG_DIR = '{{config_dir}}'
    $env:KK_LOG_DIR = '{{log_dir}}'
    $env:KK_BACKUP_DIR = '{{backup_dir}}'
    if (-not (Test-Path '{{backup_dir}}/{{system_name}}')) {
        New-Item -Path '{{backup_dir}}/{{system_name}}' -ItemType Directory -Force | Out-Null
    }
    & {{scripts_dir}}/Invoke-Backup.ps1 -SystemType '{{system_name}}' -BackupPath '{{backup_dir}}/{{system_name}}' -Verbose
    Write-Host 'Capturing current network connections snapshot...' -ForegroundColor Yellow
    $ConnectionFile = '{{log_dir}}/connections-' + (Get-Date -Format 'yyyyMMdd-HHmmss') + '.txt'
    '==== NETWORK CONNECTIONS SNAPSHOT ====' | Out-File -FilePath $ConnectionFile
    'Date: ' + (Get-Date) | Out-File -FilePath $ConnectionFile -Append
    'System: ' + $env:COMPUTERNAME | Out-File -FilePath $ConnectionFile -Append
    '' | Out-File -FilePath $ConnectionFile -Append
    & {{scripts_dir}}/Invoke-NetworkSecurityAnalysis.ps1 -OutputFile $ConnectionFile
    Write-Host 'Backup complete. See {{log_dir}}/backup.log for details.' -ForegroundColor Green
    Write-Host ('Network connection snapshot saved to ' + $ConnectionFile) -ForegroundColor Green

# Check active network connections
network-eval level="basic":
    #!{{shebang}}
    Write-Host 'Running network security analysis at {{level}} level...' -ForegroundColor Green
    if ('{{level}}' -eq 'basic') {
        & {{scripts_dir}}/Invoke-NetworkSecurityAnalysis.ps1 -DetailLevel Basic
    } else {
        & {{scripts_dir}}/Invoke-NetworkSecurityAnalysis.ps1 -DetailLevel Detailed
    }

# Install or update security tools
install-tools install_dir="C:\\SecurityTools" source_dir="":
    #!{{shebang}}
    $Params = @{ InstallDir = '{{install_dir}}' }
    if ('{{source_dir}}' -ne '') {
        $Params.Add('SourceDir', '{{source_dir}}')
    }
    Write-Host 'Installing security tools to {{install_dir}}...' -ForegroundColor Green
    & {{scripts_dir}}/Install-Tools.ps1 @Params

# Display system status dashboard
status:
    #!{{shebang}}
    Write-Host '=== keyboard kowboys system status ===' -ForegroundColor Cyan
    Write-Host ('Time: ' + (Get-Date)) -ForegroundColor Yellow
    $OS = Get-WmiObject -Class Win32_OperatingSystem
    $Uptime = (Get-Date) - $OS.ConvertToDateTime($OS.LastBootUpTime)
    Write-Host ('Uptime: ' + $Uptime.Days + ' days, ' + $Uptime.Hours + ' hours, ' + $Uptime.Minutes + ' minutes') -ForegroundColor Yellow
    Write-Host '---' -ForegroundColor Cyan
    Write-Host 'Services:' -ForegroundColor Green
    Get-Service | Where-Object {$_.Status -eq 'Running'} | Select-Object -First 10 | Format-Table -AutoSize
    Write-Host '---' -ForegroundColor Cyan
    Write-Host 'Connections:' -ForegroundColor Green
    Get-NetTCPConnection -State Listen | Select-Object -First 10 | Format-Table -AutoSize
    Write-Host '---' -ForegroundColor Cyan
    Write-Host 'Recent logon attempts:' -ForegroundColor Green
    try {
        Get-WinEvent -FilterHashtable @{LogName='Security'; ID=4625} -MaxEvents 5 |
            Select-Object TimeCreated, @{N='User';E={$_.Properties[5].Value}}, @{N='Source';E={$_.Properties[13].Value}} |
            Format-Table -AutoSize
    } catch {
        Write-Host 'No recent failed logon attempts or unable to access security log.' -ForegroundColor Yellow
    }

# Rotate Active Directory passwords
rotate-passwords output_file="{{base_dir}}/passwords.csv":
    #!{{shebang}}
    $ErrorActionPreference = 'Continue'
    $VerbosePreference = 'Continue'
    $ntdsRegPath = 'HKLM:\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Parameters'
    if (Test-Path $ntdsRegPath) {
        Write-Host 'This machine is a Domain Controller' -ForegroundColor Green
        Write-Host 'Starting password rotation process...' -ForegroundColor Cyan

        # Use absolute paths and ensure folders exist
        $outputPath = "$(Resolve-Path '{{base_dir}}' -ErrorAction Stop)/passwords.csv"

        # Call script with proper parameters
        & {{scripts_dir}}/Rotate-Passwords.ps1 -OutputFile $outputPath -Verbose *>&1 | ForEach-Object {
            Write-Host $_
        }

        # Check output
        if (Test-Path $outputPath) {
            Write-Host "Password rotation completed successfully" -ForegroundColor Green
            Write-Host "Results saved to: $outputPath" -ForegroundColor Yellow
        } else {
            Write-Host "Password rotation completed but no output file was created" -ForegroundColor Red
        }
    } else {
        Write-Host 'This machine is NOT a Domain Controller' -ForegroundColor Red
        Write-Host 'Password rotation can only be performed on a Domain Controller.' -ForegroundColor Yellow
        exit 1
    }

# Analyze system logs
analyze-logs hours="1":
    #!{{shebang}}
    $timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
    $outputFile = '{{log_dir}}/log_analysis_' + $timestamp + '.txt'
    Write-Host 'Starting log analysis for the past {{hours}} hour(s)...' -ForegroundColor Green
    Write-Host ('Analysis will be saved to: ' + $outputFile) -ForegroundColor Yellow
    & {{scripts_dir}}/Invoke-LogAnalyzer.ps1 -Hours {{hours}} -OutputFile $outputFile
    Write-Host 'Log analysis complete.' -ForegroundColor Green
    Write-Host ('Results saved to: ' + $outputFile) -ForegroundColor Green

# Run security audit with HardeningKitty
audit mode="Audit" list="" filter="":
    #!{{shebang}}
    Import-Module HardeningKitty -ErrorAction Stop
    $timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
    $reportPath = '{{log_dir}}/HardeningKitty_' + $timestamp + '.csv'
    $logPath = '{{log_dir}}/HardeningKitty_' + $timestamp + '.log'
    Write-Host 'Running HardeningKitty security audit in {{mode}} mode...' -ForegroundColor Green
    try {
        $params = @{
            Mode = '{{mode}}'
            Report = $true
            ReportFile = $reportPath
            Log = $true
            LogFile = $logPath
            EmojiSupport = $true
        }
        if ('{{list}}' -ne '') {
            $findingListPath = '{{list}}'
            if (Test-Path '{{list}}') {
                Write-Host ('Using custom finding list: ' + $findingListPath) -ForegroundColor Yellow
                $params.Add('FileFindingList', $findingListPath)
            } else {
                Write-Host ('Using {{list}} benchmark') -ForegroundColor Yellow
                $params.Add('BenchmarkName', '{{list}}')
            }
        }
        if ('{{filter}}' -ne '') {
            $filterScriptBlock = [ScriptBlock]::Create('{{filter}}')
            Write-Host ('Applying filter: {{filter}}') -ForegroundColor Yellow
            $params.Add('Filter', $filterScriptBlock)
        }
        Invoke-HardeningKitty @params
        Write-Host 'Security audit complete.' -ForegroundColor Green
        Write-Host ('Report saved to: ' + $reportPath) -ForegroundColor Green
        Write-Host ('Log saved to: ' + $logPath) -ForegroundColor Green
        if (Test-Path $reportPath) {
            $report = Import-Csv -Path $reportPath
            $totalChecks = $report.Count
            $failed = ($report | Where-Object { $_.Result -eq 'Fail' } | Measure-Object).Count
            $warning = ($report | Where-Object { $_.Result -eq 'Warning' } | Measure-Object).Count
            $pass = ($report | Where-Object { $_.Result -eq 'Pass' } | Measure-Object).Count
            $otherCount = $totalChecks - $failed - $warning - $pass
            Write-Host '' -ForegroundColor Yellow
            Write-Host '=== AUDIT SUMMARY ===' -ForegroundColor Cyan
            Write-Host ('Total Checks: ' + $totalChecks) -ForegroundColor Cyan
            Write-Host ('Passed: ' + $pass) -ForegroundColor Green
            Write-Host ('Warnings: ' + $warning) -ForegroundColor Yellow
            Write-Host ('Failed: ' + $failed) -ForegroundColor Red
            if ($otherCount -gt 0) {
                Write-Host ('Other/Unknown: ' + $otherCount) -ForegroundColor Gray
            }
        }
    } catch {
        Write-Host ('Error running HardeningKitty: ' + $_) -ForegroundColor Red
        Write-Host 'Make sure HardeningKitty is installed. Run install-tools first.' -ForegroundColor Yellow
        exit 1
    }

# Add Wazuh agent to the server
add-agent server_ip="":
    #!{{shebang}}
    Write-Host "=== Keyboard Kowboys add-agent ===" -ForegroundColor Cyan
    
    if ([string]::IsNullOrEmpty('{{server_ip}}')) {
        Write-Host "Usage: just add-agent <server_ip>" -ForegroundColor Yellow
        exit 1
    }
    
    Write-Host "Server IP {{server_ip}} will be used." -ForegroundColor Green
    
    # Execute the Wazuh agent installation script with the server IP
    & "{{scripts_dir}}\wazuh_agent_install.ps1" "{{server_ip}}"
    
    if ($LASTEXITCODE -ne 0) {
        Write-Host "Error: Agent installation failed." -ForegroundColor Red
        exit 1
    } else {
        Write-Host "Agent installation completed successfully." -ForegroundColor Green
    }
# Show PowerShell version info
ps-version:
    #!{{shebang}}
    $PSV = $PSVersionTable.PSVersion | ForEach-Object {"$_" -split "\."}
    $psver = $PSV[0] + "." + $PSV[1]
    if ($PSV[2].Length -lt 4) {
        $psver += "." + $PSV[2] + " Core"
    } else {
        $psver += " Desktop"
    }
    Write-Host "PowerShell $psver" -ForegroundColor Cyan

